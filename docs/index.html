<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GIS Spatial Data Engineering Demo</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { height: 70vh; }
    .wrap { padding: 14px 16px; }
    .links a { display: inline-block; margin-right: 14px; }
    .note { color: #555; margin-top: 8px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="wrap">
<h1>GIS Spatial Data Engineering</h1>
<p>
  End-to-end spatial data pipeline demo: ingest Natural Earth, standardize/QA, model in DuckDB Spatial,
  run spatial join analytics, and publish results as an interactive web map.
</p>
<ul>
  <li>Reproducible pipeline: <code>run_all.ps1</code> / <code>run_all.sh</code></li>
  <li>QA report generated on every run</li>
  <li>DuckDB Spatial + R-tree index + explain plans</li>
  <li>Live demo map built from committed samples for fast loading</li>
</ul>

    <h2>Pipeline Outputs</h2>
    <div class="links">
      <a href="./qa/admin1_qa_report.csv">QA report (admin1)</a>
      <a href="./results/admin1_canada_area_km2.csv">Canada area (kmÂ²)</a>
      <a href="./results/cities_by_canada_province.csv">Cities by Canada province</a>
      <a href="./results/cities_by_admin1_top50.csv">Top 50 admin1 by city count</a>
    </div>
    <div class="note">Map layers are generated from committed samples for fast loading.</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([56.5, -96.5], 3);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    function styleAdmin1() {
      return { weight: 1, fillOpacity: 0.15 };
    }

    async function loadGeoJSON(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`Failed ${url}: ${r.status}`);
      return await r.json();
    }

    (async () => {
      const admin1 = await loadGeoJSON("./data/canada_admin1.geojson");
      const cities = await loadGeoJSON("./data/canada_cities.geojson");

      const adminLayer = L.geoJSON(admin1, {
        style: styleAdmin1,
        onEachFeature: (f, layer) => {
          const p = f.properties || {};
          layer.bindPopup(`<b>${p.name || "Unknown"}</b><br/>${p.adm1_code || ""}`);
        }
      }).addTo(map);

      const cityLayer = L.geoJSON(cities, {
        pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 4 }),
        onEachFeature: (f, layer) => {
          const p = f.properties || {};
          layer.bindPopup(`<b>${p.name || "City"}</b><br/>pop_max: ${p.pop_max ?? "n/a"}`);
        }
      }).addTo(map);

      L.control.layers(
        { "Canada Admin-1": adminLayer },
        { "Cities": cityLayer },
        { collapsed: false }
      ).addTo(map);

      map.fitBounds(adminLayer.getBounds());
    })();
  </script>
</body>
</html>
